<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÆ Mini Arcade V3 - √ñlme Yok Modu</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#111; color:#fff; text-align:center; }
header { background:#222; padding:20px; }
header h1 { margin:0; font-size:28px; color:#00ff88; }
#menu { display:flex; justify-content:center; flex-wrap:wrap; gap:15px; padding:20px; }
.game-btn { background:#333; border:2px solid #00ff88; color:#fff; padding:15px 30px; border-radius:10px; cursor:pointer; font-size:18px; transition:0.3s; }
.game-btn:hover { background:#00ff88; color:#111; }
#gameArea { margin:20px auto; max-width:800px; background:#000; border:2px solid #00ff88; border-radius:10px; padding:10px; }
canvas { display:block; margin:0 auto; background:#000; width:100%; height:auto; max-width:800px; }

/* D√ºzeltildi: show class eklendi, animasyon √ßalƒ±≈üƒ±yor */
#customAlert {
  position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:#222; color:#0ff; padding:20px 30px; border-radius:12px;
  font-size:20px; font-weight:bold; display:none;
  box-shadow:0 0 20px #0ff; z-index:9999; text-align:center;
  opacity:0; transition: opacity 0.4s ease;
}
#customAlert.show { opacity:1; }
</style>
</head>
<body>
<header>
  <h1>üéÆ Mini Arcade V3 - √ñlme Yok Modu</h1>
</header>

<div id="customAlert">Oyun Bitti! üéÆ</div>

<div id="menu">
  <button class="game-btn" onclick="loadGame('snake')">üêç Yƒ±lan</button>
  <button class="game-btn" onclick="loadGame('pong')">üèì Pong</button>
  <button class="game-btn" onclick="loadGame('tetris')">üß± Tetris</button>
  <button class="game-btn" onclick="loadGame('flappy')">üê¶ Flappy Bird</button>
  <button class="game-btn" onclick="loadGame('car')">üöó Araba Yarƒ±≈üƒ±</button>
</div>

<div style="position:absolute; top:10px; right:10px;">
  <button onclick="logout()" style="padding:8px 12px; background:#f00; color:#fff; border:none; border-radius:6px;">G√ºvenli √áƒ±kƒ±≈ü</button>
</div>

<div style="position:absolute; top:10px; right:130px; background:#222; color:#0ff; padding:8px 12px; border-radius:6px;">
  Coin: <span id="coinDisplay">0</span>
</div>

<div id="gameArea">
  <p>Bir oyun se√ßmek i√ßin yukarƒ±daki butonlara tƒ±kla üöÄ</p>
  <div id="canvasContainer"></div>
</div>

<script>
function logout(){
  alert("√áok √ºzg√ºn√ºz, gitme l√ºtfen üò¢");
  localStorage.removeItem("loggedInUser");
  window.location.href="login.html";
}

function updateCoinDisplay(){
  try {
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    document.getElementById("coinDisplay").textContent = user?.coin || 0;
  } catch(e) {
    document.getElementById("coinDisplay").textContent = 0;
  }
}
updateCoinDisplay();

function showCustomAlert(message){
  const alertBox = document.getElementById("customAlert");
  alertBox.textContent = message;
  alertBox.style.display = "block";
  // K√º√ß√ºk gecikme ile show eklenmezse opacity ge√ßi≈üi √ßalƒ±≈ümaz
  setTimeout(() => alertBox.classList.add("show"), 10);
  setTimeout(() => {
    alertBox.classList.remove("show");
    setTimeout(() => alertBox.style.display = "none", 400);
  }, 3000);
}

function updateUserCoin(earnedCoin){
  try {
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!loggedInUser) return;
    const users = JSON.parse(localStorage.getItem("users") || "[]");
    const index = users.findIndex(u => u["Kullanƒ±cƒ± Adƒ±"] === loggedInUser["Kullanƒ±cƒ± Adƒ±"]);
    if(index !== -1){
      users[index]["coin"] = (users[index]["coin"] || 0) + earnedCoin;
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("loggedInUser", JSON.stringify(users[index]));
    }
    updateCoinDisplay();
  } catch(e) {}
}

// D√ºzeltildi: keydown listener temizleniyor, her oyun kendi listener'ƒ±nƒ± y√∂netiyor
let currentKeyHandler = null;
let currentMouseHandler = null;

function setKeyHandler(fn){
  if(currentKeyHandler) document.removeEventListener("keydown", currentKeyHandler);
  currentKeyHandler = fn;
  document.addEventListener("keydown", fn);
}

function setMouseHandler(fn){
  if(currentMouseHandler) document.removeEventListener("mousemove", currentMouseHandler);
  currentMouseHandler = fn;
  document.addEventListener("mousemove", fn);
}

function loadGame(game){
  if(window.currentGameInterval) clearInterval(window.currentGameInterval);
  const container = document.getElementById("canvasContainer");
  container.innerHTML = "";
  document.getElementById("gameArea").querySelector("p") && (document.getElementById("gameArea").querySelector("p").style.display = "none");
  if(game === "snake") startSnake(container);
  else if(game === "pong") startPong(container);
  else if(game === "tetris") startTetris(container);
  else if(game === "flappy") startFlappy(container);
  else if(game === "car") startCar(container);
}

// ---------------- Snake ----------------
function startSnake(container){
  container.innerHTML = "<canvas id='snakeCanvas' width='400' height='400'></canvas>";
  const canvas = document.getElementById("snakeCanvas");
  const ctx = canvas.getContext("2d");
  const box = 20;
  let snake = [{x: 9*box, y: 10*box}];
  let food = {x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box};
  let d = "RIGHT";
  let score = 0;

  // D√ºzeltildi: setKeyHandler ile eski listener temizleniyor
  setKeyHandler(function(event){
    if(event.keyCode===37 && d!=="RIGHT") d="LEFT";
    else if(event.keyCode===38 && d!=="DOWN") d="UP";
    else if(event.keyCode===39 && d!=="LEFT") d="RIGHT";
    else if(event.keyCode===40 && d!=="UP") d="DOWN";
  });

  function collision(head, array){ return array.some(s => s.x===head.x && s.y===head.y); }

  function draw(){
    ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
    snake.forEach((seg,i)=>{
      ctx.fillStyle = (i===0) ? "#00ff88" : "#fff";
      ctx.fillRect(seg.x, seg.y, box, box);
    });
    ctx.fillStyle="red"; ctx.fillRect(food.x, food.y, box, box);
    ctx.fillStyle="#0ff"; ctx.font="14px Arial"; ctx.fillText(`Skor: ${score}`, 10, 15);

    let snakeX = snake[0].x;
    let snakeY = snake[0].y;
    if(d==="LEFT") snakeX -= box;
    if(d==="UP")   snakeY -= box;
    if(d==="RIGHT") snakeX += box;
    if(d==="DOWN") snakeY += box;

    if(snakeX===food.x && snakeY===food.y){
      food = {x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box};
      score++;
    } else snake.pop();

    const newHead = {x: snakeX, y: snakeY};
    if(snakeX<0 || snakeY<0 || snakeX>=canvas.width || snakeY>=canvas.height || collision(newHead, snake)){
      updateUserCoin(Math.floor(score/10));
      showCustomAlert(`Yƒ±lan Oyunu Bitti! Skor: ${score} üêç`);
      snake = [{x: 9*box, y: 10*box}];
      score = 0;
      food = {x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box};
      d = "RIGHT";
      return;
    }
    snake.unshift(newHead);
  }

  window.currentGameInterval = setInterval(draw, 100);
}

// ---------------- Pong ----------------
function startPong(container){
  container.innerHTML = "<canvas id='pongCanvas' width='500' height='300'></canvas>";
  const canvas = document.getElementById("pongCanvas");
  const ctx = canvas.getContext("2d");
  const paddleH=75, paddleW=10;
  let playerY = (canvas.height-paddleH)/2;
  let aiY = (canvas.height-paddleH)/2;
  let ballX=canvas.width/2, ballY=canvas.height/2;
  const ballR=10;
  let dx=3, dy=-3;
  let playerScore=0, aiScore=0;

  setMouseHandler(e=>{
    const rect = canvas.getBoundingClientRect();
    const relativeY = e.clientY - rect.top;
    if(relativeY>0 && relativeY<canvas.height) playerY = relativeY - paddleH/2;
  });

  // D√ºzeltildi: keydown yok pong'da, temizleniyor
  setKeyHandler(()=>{});

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#00ff88";
    ctx.fillRect(0, playerY, paddleW, paddleH);
    ctx.fillRect(canvas.width-paddleW, aiY, paddleW, paddleH);
    ctx.beginPath(); ctx.arc(ballX,ballY,ballR,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill(); ctx.closePath();
    ctx.font="16px Arial"; ctx.fillStyle="#fff";
    ctx.fillText(`Oyuncu: ${playerScore}`, 20, 20);
    ctx.fillText(`AI: ${aiScore}`, canvas.width-80, 20);

    ballX += dx; ballY += dy;
    if(ballY-ballR<0 || ballY+ballR>canvas.height) dy=-dy;
    if(ballX-ballR<paddleW && ballY>playerY && ballY<playerY+paddleH){ dx=Math.abs(dx); }
    if(ballX+ballR>canvas.width-paddleW && ballY>aiY && ballY<aiY+paddleH){ dx=-Math.abs(dx); }
    if(ballX<0){ aiScore++; ballX=canvas.width/2; ballY=canvas.height/2; }
    else if(ballX>canvas.width){ playerScore++; ballX=canvas.width/2; ballY=canvas.height/2; }

    aiY += (ballY-(aiY+paddleH/2))*0.05;
  }

  window.currentGameInterval = setInterval(draw, 20);
}

// ---------------- Tetris ----------------
function startTetris(container){
  container.innerHTML = "<canvas id='tetrisCanvas'></canvas>";
  const canvas = document.getElementById("tetrisCanvas");
  const ctx = canvas.getContext("2d");
  const COLS=10, ROWS=20, BLOCK=24;
  canvas.width=COLS*BLOCK; canvas.height=ROWS*BLOCK;
  const COLORS=["#00ff88","#ff0055","#ffaa00","#00aaff","#aa00ff","#00ffff","#ffffff"];
  const SHAPES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]]];
  let board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  let current=createPiece(), score=0;

  function createPiece(){
    const t=Math.floor(Math.random()*SHAPES.length);
    return {shape:SHAPES[t], color:COLORS[t], x:3, y:0};
  }
  function drawBlock(x,y,color){
    ctx.fillStyle=color; ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK-1,BLOCK-1);
  }
  function drawBoard(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) if(board[y][x]) drawBlock(x,y,board[y][x]);
    current.shape.forEach((row,dy)=>row.forEach((v,dx)=>{ if(v) drawBlock(current.x+dx, current.y+dy, current.color); }));
    ctx.fillStyle="#fff"; ctx.font="14px Arial"; ctx.fillText(`Skor: ${score}`, 4, canvas.height-6);
  }
  function collides(){ return current.shape.some((row,dy)=>row.some((v,dx)=>v&&(board[current.y+dy]?.[current.x+dx]!==0||current.x+dx<0||current.x+dx>=COLS||current.y+dy>=ROWS))); }
  function move(dir){ current.x+=dir; if(collides()) current.x-=dir; }
  function rotate(){ const old=current.shape; current.shape=current.shape[0].map((_,i)=>current.shape.map(r=>r[i])).reverse(); if(collides()) current.shape=old; }
  function merge(){ current.shape.forEach((row,dy)=>row.forEach((v,dx)=>{ if(v) board[current.y+dy][current.x+dx]=current.color; })); clearLines(); }
  function clearLines(){ for(let y=ROWS-1;y>=0;y--){ if(board[y].every(c=>c)){ board.splice(y,1); board.unshift(Array(COLS).fill(0)); score+=10; y++; } } }
  function drop(){ current.y++; if(collides()){ current.y--; merge(); current=createPiece(); if(collides()){ updateUserCoin(Math.floor(score/10)); showCustomAlert(`Tetris Bitti! Skor: ${score} üß±`); board=Array.from({length:ROWS},()=>Array(COLS).fill(0)); score=0; } } }

  setKeyHandler(e=>{
    if(e.keyCode===37) move(-1);
    else if(e.keyCode===39) move(1);
    else if(e.keyCode===40) drop();
    else if(e.keyCode===38) rotate();
  });

  window.currentGameInterval=setInterval(()=>{ drop(); drawBoard(); }, 500);
}

// ---------------- Flappy Bird ----------------
function startFlappy(container){
  if(window.currentGameInterval) clearInterval(window.currentGameInterval);
  container.innerHTML="<canvas id='flappyCanvas' width='320' height='480'></canvas>";
  const canvas=document.getElementById("flappyCanvas");
  const ctx=canvas.getContext("2d");

  // D√ºzeltildi: gravity ve velocity ayrƒ± ayrƒ± deƒüil, tek fizik sistemi
  let birdY=200, velocity=0, score=0;
  const GRAVITY=0.4, JUMP=-8;
  let pipes=[{x:canvas.width, y:Math.random()*150+50}];
  let alive=true;

  setKeyHandler(e=>{ if(e.keyCode===32 && alive){ velocity=JUMP; e.preventDefault(); } });

  function drawFlappy(){
    if(!alive) return;
    ctx.fillStyle="#70c5ce"; ctx.fillRect(0,0,canvas.width,canvas.height);

    // Ku≈ü
    ctx.fillStyle="yellow";
    ctx.beginPath(); ctx.arc(60, birdY, 15, 0, Math.PI*2); ctx.fill(); ctx.closePath();

    // Fizik
    velocity+=GRAVITY;
    birdY+=velocity;

    // Zemin/tavan √ßarpƒ±≈ümasƒ±
    if(birdY-15<0 || birdY+15>canvas.height){
      endFlappy(score);
      return;
    }

    const GAP=120;
    for(let i=0;i<pipes.length;i++){
      const p=pipes[i];
      ctx.fillStyle="#228B22";
      ctx.fillRect(p.x, 0, 50, p.y);
      ctx.fillRect(p.x, p.y+GAP, 50, canvas.height);
      p.x--;

      // √áarpƒ±≈üma
      if(60+15>p.x && 60-15<p.x+50 && (birdY-15<p.y || birdY+15>p.y+GAP)){
        endFlappy(score);
        return;
      }
      if(p.x+50<0){ pipes.splice(i,1); i--; score++; }
    }

    if(pipes[pipes.length-1].x < canvas.width-180){
      pipes.push({x:canvas.width, y:Math.random()*150+60});
    }

    ctx.fillStyle="#fff"; ctx.font="20px Arial"; ctx.fillText(`Skor: ${score}`, 10, 30);
  }

  function endFlappy(finalScore){
    alive=false;
    clearInterval(window.currentGameInterval);
    updateUserCoin(finalScore);
    showCustomAlert(`Flappy Bitti! Skor: ${finalScore} üê¶`);
  }

  window.currentGameInterval=setInterval(drawFlappy, 20);
}

// ---------------- Araba Yarƒ±≈üƒ± ----------------
function startCar(container){
  if(window.currentGameInterval) clearInterval(window.currentGameInterval);
  container.innerHTML="<canvas id='carCanvas' width='300' height='500'></canvas>";
  const canvas=document.getElementById("carCanvas");
  const ctx=canvas.getContext("2d");
  let car={x:130, y:400, w:40, h:60};
  let obstacles=[], score=0, alive=true;
  let keys={};

  setKeyHandler(e=>{ keys[e.keyCode]=true; });
  document.addEventListener("keyup", e=>{ keys[e.keyCode]=false; });

  function drawCarGame(){
    if(!alive) return;

    // Tu≈ü basƒ±lƒ± tutma desteƒüi
    if(keys[37] && car.x>0) car.x-=4;
    if(keys[39] && car.x<canvas.width-car.w) car.x+=4;

    ctx.fillStyle="#444"; ctx.fillRect(0,0,canvas.width,canvas.height);
    // Yol √ßizgileri
    ctx.setLineDash([20,15]); ctx.strokeStyle="#fff"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(canvas.width/2,0); ctx.lineTo(canvas.width/2,canvas.height); ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle="#e74c3c"; ctx.fillRect(car.x, car.y, car.w, car.h);

    if(obstacles.length===0 || obstacles[obstacles.length-1].y>120){
      const obsW=Math.floor(Math.random()*80)+40;
      obstacles.push({x:Math.floor(Math.random()*(canvas.width-obsW)), y:-50, w:obsW, h:25});
    }

    for(let i=0;i<obstacles.length;i++){
      ctx.fillStyle="#27ae60";
      ctx.fillRect(obstacles[i].x, obstacles[i].y, obstacles[i].w, obstacles[i].h);
      obstacles[i].y+=4;

      if(car.x<obstacles[i].x+obstacles[i].w && car.x+car.w>obstacles[i].x && car.y<obstacles[i].y+obstacles[i].h && car.y+car.h>obstacles[i].y){
        alive=false;
        clearInterval(window.currentGameInterval);
        updateUserCoin(score);
        showCustomAlert(`Araba Yarƒ±≈üƒ± Bitti! Skor: ${score} üöó`);
        return;
      }
      if(obstacles[i].y>canvas.height){ obstacles.splice(i,1); i--; score++; }
    }

    ctx.fillStyle="#0ff"; ctx.font="20px Arial"; ctx.fillText(`Skor: ${score}`, 10, 30);
  }

  window.currentGameInterval=setInterval(drawCarGame, 20);
}
</script>
</body>
</html>
